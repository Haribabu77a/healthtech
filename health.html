<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KeyCare ‚Äî Simple Healthcare for Everyone</title>
  <meta name="description" content="KeyCare: accessible healthcare helper with voice assistant, medicine lookup, triage questions and medication reminders." />
  <style>
    :root{
      --bg:#fff;
      --fg:#111;
      --accent:#007ACC;
      --large:20px;
      --radius:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans", Arial;
      background:linear-gradient(180deg,#f6f9fc,#ffffff);
      color:var(--fg);
      font-size:18px;
    }

    .topbar{
      display:flex;
      gap:12px;
      align-items:center;
      padding:10px;
      background:var(--accent);
      color:white;
      position:sticky;
      top:0;
      z-index:20;
    }
    .hamburger{
      font-size:28px;
      background:transparent;
      border:none;
      color:white;
      width:48px;height:48px;border-radius:8px;
    }
    .title-and-search{flex:1}
    #site-title{margin:0;font-size:26px}
    .search-row{display:flex;gap:8px;margin-top:6px}
    .search-row input{
      flex:1;padding:10px;border-radius:8px;border:2px solid rgba(255,255,255,0.6);
      font-size:18px;
    }
    .search-row button{
      padding:10px 12px;border-radius:8px;border:none;background:white;color:var(--accent);font-size:18px;
    }

    .lang-select{display:flex;flex-direction:column;font-size:14px}
    .lang-select select{padding:6px;border-radius:6px}

    .side-menu{
      position:fixed;left:0;top:64px;width:220px;background:#fff;box-shadow:2px 4px 12px rgba(0,0,0,0.15);padding:12px;border-radius:0 8px 8px 0;
      transform:translateX(-120%);transition:transform .25s;z-index:30;
    }
    .side-menu[aria-hidden="false"]{transform:translateX(0)}
    .side-menu ul{list-style:none;padding:0;margin:0}
    .side-menu a{display:block;padding:10px;border-radius:8px;text-decoration:none;color:var(--fg)}

    main{padding:16px;max-width:980px;margin:0 auto}
    .floating-menu{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-bottom:16px}
    .float-btn{
      display:flex;flex-direction:column;align-items:center;padding:8px;background:#fff;border-radius:16px;border:2px solid #eee;width:120px;height:140px;
      font-size:18px;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,0.08)
    }
    .float-btn img{width:80px;height:80px;object-fit:contain}
    .float-btn span{margin-top:8px;font-weight:600}

    .panel{background:#fff;padding:14px;border-radius:12px;margin-bottom:16px;box-shadow:0 6px 18px rgba(0,0,0,0.04)}
    .desc{color:#333;margin-top:6px}
    .medicine-search,input[type=text],textarea{width:100%;padding:10px;border-radius:8px;border:2px solid #eee;font-size:18px}
    .medicine-search{display:flex;gap:8px;margin-top:10px}
    .medicine-search button{padding:10px 14px;border-radius:8px;border:none;background:var(--accent);color:white}

    .result{margin-top:12px;padding:10px;background:#fafafa;border-radius:8px;border:1px dashed #eee;min-height:40px}

    .assistant-controls{display:flex;flex-direction:column;gap:8px}
    .assistant-buttons{display:flex;gap:8px;flex-wrap:wrap}
    .assistant-buttons button{flex:1;padding:10px;border-radius:8px;border:none;background:var(--accent);color:white}

    .triage-area{display:flex;flex-direction:column;gap:8px}
    .triage-area .question{font-size:20px;padding:10px}
    .choices{display:flex;gap:8px;flex-wrap:wrap}
    .choices button{flex:1;padding:12px;border-radius:12px;border:none;background:#eee;font-size:18px}

    .tablet-form{display:flex;gap:8px;align-items:end;flex-wrap:wrap}
    .tablet-form label{display:flex;flex-direction:column;gap:6px}
    .tablet-list{margin-top:12px;list-style:none;padding:0}
    .tablet-list li{padding:8px;border-radius:8px;background:#fff;border:1px solid #eee;margin-bottom:8px;display:flex;justify-content:space-between;gap:8px;align-items:center}

    .footer{text-align:center;padding:14px;color:#666;background:transparent;margin-top:18px;border-top:1px solid #f0f0f0}
    @media (max-width:600px){
      .floating-menu{gap:10px}
      .float-btn{width:48%;max-width:220px}
    }
  </style>
</head>
<body>
  <header class="topbar" role="banner">
    <button id="hamburger" class="hamburger" aria-label="Open menu" title="Menu">‚ò∞</button>

    <div class="title-and-search">
      <h1 id="site-title">KeyCare</h1>
      <div class="search-row">
        <input id="global-search" type="search" placeholder="Search settings or medicines..." aria-label="Search" />
        <button id="search-btn" aria-label="Search">üîç</button>
      </div>
    </div>

    <div class="lang-select">
      <label for="lang" style="color:white;font-weight:600">Language</label>
      <select id="lang" aria-label="Choose language">
        <option value="en">English</option>
        <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)</option>
        <option value="ml">‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç (Malayalam)</option>
        <option value="kn">‡≤ï‡≤®‡≥ç‡≤®‡≤° (Kannada)</option>
        <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)</option>
        <option value="es">Espa√±ol (Spanish)</option>
        <option value="fr">Fran√ßais (French)</option>
      </select>
    </div>
  </header>

  <nav id="side-menu" class="side-menu" aria-hidden="true">
    <ul>
      <li><a href="#medicines">Medicines</a></li>
      <li><a href="#assistant">Assistant</a></li>
      <li><a href="#triage">I don't know how I feel</a></li>
      <li><a href="#tablets">Tablets / Schedule</a></li>
      <li><a href="#settings">Settings</a></li>
    </ul>
  </nav>

  <main id="main" role="main">
    <section class="floating-menu" aria-label="Main features">
      <button class="float-btn" data-target="#medicines" aria-label="Medicines">
        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='80' height='80'><rect rx='12' width='80' height='80' fill='%23ffcc00'/><text x='50%' y='55%' font-size='32' text-anchor='middle' fill='%23000' font-family='Arial'>üíä</text></svg>" alt="Pill" />
        <span>Medicines</span>
      </button>

      <button class="float-btn" data-target="#assistant" aria-label="Assistant">
        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='80' height='80'><rect rx='12' width='80' height='80' fill='%2300ccff'/><text x='50%' y='55%' font-size='34' text-anchor='middle' fill='%23000' font-family='Arial'>üó£Ô∏è</text></svg>" alt="Assistant" />
        <span>Assistant</span>
      </button>

      <button class="float-btn" data-target="#triage" aria-label="Triage">
        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='80' height='80'><rect rx='12' width='80' height='80' fill='%23ff6666'/><text x='50%' y='55%' font-size='32' text-anchor='middle' fill='%23000' font-family='Arial'>‚ùì</text></svg>" alt="Help" />
        <span>I don't know</span>
      </button>

      <button class="float-btn" data-target="#tablets" aria-label="Tablets">
        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='80' height='80'><rect rx='12' width='80' height='80' fill='%2380ff80'/><text x='50%' y='55%' font-size='32' text-anchor='middle' fill='%23000' font-family='Arial'>‚è∞</text></svg>" alt="Alarm" />
        <span>Tablets</span>
      </button>
    </section>

    <section id="medicines" class="panel" aria-labelledby="medicines-heading">
      <h2 id="medicines-heading">Medicines</h2>
      <p class="desc">Search for a medicine name and the site will fetch a short summary (from Wikipedia).</p>
      <div class="medicine-search">
        <input id="medicine-name" type="text" placeholder="Type medicine name (e.g., Paracetamol)" aria-label="Medicine name" />
        <button id="medicine-search-btn">Search</button>
      </div>
      <article id="medicine-result" class="result" aria-live="polite"></article>
    </section>

    <section id="assistant" class="panel" aria-labelledby="assistant-heading">
      <h2 id="assistant-heading">Assistant</h2>
      <p class="desc">Speak to the assistant or type how you feel. It will suggest simple actions and speak them aloud.</p>

      <div class="assistant-controls">
        <textarea id="assistant-input" rows="2" placeholder="Describe how you feel..." aria-label="Describe how you feel"></textarea>
        <div class="assistant-buttons">
          <button id="speak-btn">Speak</button>
          <button id="listen-btn">Start Listening</button>
          <button id="assistant-submit">Get Advice</button>
        </div>
      </div>

      <div id="assistant-output" class="result" aria-live="polite"></div>
    </section>

    <section id="triage" class="panel" aria-labelledby="triage-heading">
      <h2 id="triage-heading">Don't know how you feel?</h2>
      <p class="desc">Answer simple spoken or tapped questions ‚Äî the assistant will guide you step-by-step.</p>
      <div id="triage-area" class="triage-area" aria-live="polite">
        <button id="start-triage">Start</button>
        <div id="triage-question" class="question" hidden></div>
        <div id="triage-choices" class="choices" hidden></div>
      </div>
    </section>

    <section id="tablets" class="panel" aria-labelledby="tablets-heading">
      <h2 id="tablets-heading">Tablets & Schedule</h2>
      <p class="desc">Add medicines and times. The site will remind you when it's time (notifications + sound) while the page is open. Allow notifications and sound.</p>

      <form id="tablet-form" class="tablet-form" onsubmit="return false;">
        <label>Medicine name
          <input id="tab-name" required placeholder="e.g., Paracetamol" />
        </label>
        <label>Time
          <input id="tab-time" type="time" required />
        </label>
        <button id="add-tablet">Add reminder</button>
      </form>

      <ul id="tablet-list" class="tablet-list" aria-live="polite"></ul>
    </section>

    <section id="settings" class="panel" aria-labelledby="settings-heading">
      <h2 id="settings-heading">Settings</h2>
      <p class="desc">Toggle voice and notification preferences.</p>
      <label><input type="checkbox" id="voice-enabled" checked /> Voice (speak UI prompts)</label><br/>
      <label><input type="checkbox" id="auto-speak-results" checked /> Auto speak search / results</label><br/>
      <button id="request-notif">Allow Notifications</button>
    </section>
  </main>

  <footer class="footer">
    <small>KeyCare ‚Äî Simple healthcare helpers. For serious emergencies call local services immediately.</small>
  </footer>

  <!-- tiny silent audio to play on reminders -->
  <audio id="alarm-sound" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA="></audio>

  <script>
    // KeyCare single-file app.js (in-page)
    (function(){
      // --- Utilities and state ---
      const translations = {
        en: {
          siteTitle: "KeyCare",
          medicines: "Medicines",
          assistant: "Assistant",
          dontKnow: "I don't know",
          tablets: "Tablets",
          searchPlaceholder: "Search settings or medicines..."
        },
        ta: { siteTitle: "‡Æï‡ØÄ‡Æï‡Øá‡Æ∞‡Øç", medicines: "‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ‡Æï‡Æ≥‡Øç", assistant: "‡Æâ‡Æ§‡Æµ‡Æø‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øç", dontKnow: "‡Æé‡Æ©‡Æï‡Øç‡Æï‡ØÅ ‡Æ§‡ØÜ‡Æ∞‡Æø‡ÆØ‡Ææ‡Æ§‡ØÅ", tablets: "‡ÆÆ‡Ææ‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡Øà‡Æï‡Æ≥‡Øç", searchPlaceholder: "‡ÆÖ‡ÆÆ‡Øà‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ ‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ‡Æï‡Æ≥‡Øç ‡Æ§‡Øá‡Æü‡ØÅ..." },
        ml: { siteTitle: "‡¥ï‡µÄ‡¥ï‡µÜ‡¥Ø‡µº", medicines: "‡¥Æ‡¥∞‡µÅ‡¥®‡µç‡¥®‡µÅ‡¥ï‡µæ", assistant: "‡¥∏‡¥π‡¥æ‡¥Ø‡¥ø", dontKnow: "‡¥é‡¥®‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥Ö‡¥±‡¥ø‡¥Ø‡¥ø‡¥≤‡µç‡¥≤", tablets: "‡¥Æ‡µÇ‡¥≤‚Äå‡¥ï‡µæ", searchPlaceholder: "‡¥ï‡µç‡¥∞‡¥Æ‡µÄ‡¥ï‡¥∞‡¥£‡¥ô‡µç‡¥ô‡µæ ‡¥Ö‡¥≤‡µç‡¥≤‡µÜ‡¥ô‡µç‡¥ï‡¥ø‡µΩ ‡¥Æ‡¥∞‡µÅ‡¥®‡µç‡¥®‡µÅ‡¥ï‡µæ ‡¥§‡¥ø‡¥∞‡¥Ø‡µÅ‡¥ï..." },
        kn: { siteTitle: "‡≤ï‡≥Ä‡≤ï‡≥á‡≤∞‡≥ç", medicines: "‡≤Æ‡≤¶‡≥ç‡≤¶‡≥Ü", assistant: "‡≤∏‡≤π‡≤æ‡≤Ø", dontKnow: "‡≤®‡≤®‡≤ó‡≥Ü ‡≤ó‡≥ä‡≤§‡≥ç‡≤§‡≤ø‡≤≤‡≥ç‡≤≤", tablets: "‡≤ó‡≥ä‡≤≥‡≤ø‡≤ï‡≥Ü‡≤ó‡≤≥‡≥Å", searchPlaceholder: "‡≤∏‡≥Ü‡≤ü‡≥ç‡≤ü‡≤ø‡≤Ç‡≤ó‡≥ç‡≤∏‡≥ç ‡≤Ö‡≤•‡≤µ‡≤æ ‡≤î‡≤∑‡≤ß‡≤ø‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤π‡≥Å‡≤°‡≥Å‡≤ï‡≤ø..." },
        te: { siteTitle: "‡∞ï‡±Ä‡∞ï‡±á‡∞∞‡±ç", medicines: "‡∞Æ‡∞Ç‡∞¶‡±Å‡∞≤‡±Å", assistant: "‡∞∏‡∞π‡∞æ‡∞Ø‡∞ï‡±Å‡∞°‡±Å", dontKnow: "‡∞®‡∞æ‡∞ï‡∞Ç‡∞ü‡±á ‡∞§‡±Ü‡∞≤‡∞ø‡∞Ø‡∞¶‡±Å", tablets: "‡∞ó‡±ä‡∞≤‡±Å‡∞¨‡±Å‡∞≤‡±Å", searchPlaceholder: "‡∞∏‡±Ü‡∞ü‡±ç‡∞ü‡∞ø‡∞Ç‡∞ó‡±ç‡∞∏‡±ç ‡∞≤‡±á‡∞¶‡∞æ ‡∞Æ‡∞Ç‡∞¶‡±Å‡∞≤‡∞®‡±Å ‡∞∂‡±ã‡∞ß‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø..." },
        es: { siteTitle: "KeyCare", medicines: "Medicamentos", assistant: "Asistente", dontKnow: "No s√©", tablets: "Pastillas", searchPlaceholder: "Buscar ajustes o medicamentos..." },
        fr: { siteTitle: "KeyCare", medicines: "M√©dicaments", assistant: "Assistant", dontKnow: "Je ne sais pas", tablets: "Comprim√©s", searchPlaceholder: "Rechercher param√®tres o medicamentos..." }
      };

      const langToSpeech = {
        en: "en-US",
        es: "es-ES",
        fr: "fr-FR",
        ta: "ta-IN",
        ml: "ml-IN",
        kn: "kn-IN",
        te: "te-IN"
      };

      let currentLang = localStorage.getItem('kc-lang') || 'en';
      let voiceEnabled = true;
      let autoSpeak = true;
      const $ = id => document.getElementById(id);

      // --- TTS helper ---
      function speak(text, lang = currentLang) {
        if (!voiceEnabled) return;
        if (!('speechSynthesis' in window)) return;
        const utter = new SpeechSynthesisUtterance(String(text));
        utter.lang = langToSpeech[lang] || 'en-US';
        const voices = speechSynthesis.getVoices();
        const v = voices.find(x => (x.lang || '').startsWith(utter.lang.split('-')[0]));
        if (v) utter.voice = v;
        speechSynthesis.cancel();
        speechSynthesis.speak(utter);
      }

      // --- UI wiring ---
      function applyTranslations() {
        const t = translations[currentLang] || translations.en;
        $('site-title').textContent = t.siteTitle;
        document.getElementById('medicines-heading').textContent = t.medicines;
        document.getElementById('assistant-heading').textContent = t.assistant;
        document.getElementById('triage-heading').textContent = translations[currentLang]?.dontKnow || translations.en.dontKnow;
        document.getElementById('tablets-heading').textContent = t.tablets || 'Tablets';
        $('global-search').placeholder = t.searchPlaceholder || translations.en.searchPlaceholder;
      }
      applyTranslations();

      // Hamburger menu
      $('hamburger').addEventListener('click', () => {
        const menu = $('side-menu');
        const open = menu.getAttribute('aria-hidden') === 'false';
        menu.setAttribute('aria-hidden', String(!open));
      });

      // Floating buttons navigation
      document.querySelectorAll('.float-btn').forEach(btn=>{
        btn.addEventListener('click', () => {
          const target = document.querySelector(btn.dataset.target);
          if (target) {
            target.scrollIntoView({behavior:'smooth', block:'start'});
            speak(btn.textContent.trim());
          }
        });
      });

      // Language selector
      $('lang').value = currentLang;
      $('lang').addEventListener('change', (e)=>{
        currentLang = e.target.value;
        localStorage.setItem('kc-lang', currentLang);
        applyTranslations();
        speak(translations[currentLang]?.siteTitle || 'KeyCare', currentLang);
      });

      // Settings toggles
      $('voice-enabled').addEventListener('change', (e)=>{ voiceEnabled = e.target.checked; });
      $('auto-speak-results').addEventListener('change', (e)=>{ autoSpeak = e.target.checked; });

      // Request notifications
      $('request-notif').addEventListener('click', async ()=>{
        if (!('Notification' in window)) return alert('Notifications not supported');
        const p = await Notification.requestPermission();
        alert('Notification permission: ' + p);
      });

      // Global search
      $('search-btn').addEventListener('click', ()=>{
        const q = $('global-search').value.trim();
        if (!q) {
          speak('Please type or say something to search');
          return;
        }
        const ql = q.toLowerCase();
        if (ql.includes('medic') || ql.includes('pill') || ql.includes('‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§') || ql.includes('‡ÆÆ‡Ææ‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡Øà')){
          document.querySelector('#medicines').scrollIntoView({behavior:'smooth'});
          speak('Opening medicines');
        } else {
          $('medicine-name').value = q;
          $('medicine-search-btn').click();
        }
      });

      // --- Medicine lookup using Wikipedia API ---
      async function searchWikipedia(query){
        const url = `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&utf8=&format=json&origin=*`;
        const res = await fetch(url);
        const j = await res.json();
        if (j.query && j.query.search && j.query.search.length) {
          return j.query.search[0].title;
        }
        return null;
      }

      async function fetchSummary(title){
        const url = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('Not found');
        const j = await res.json();
        return j.extract || j.description || '';
      }

      $('medicine-search-btn').addEventListener('click', async ()=>{
        const q = $('medicine-name').value.trim();
        const out = $('medicine-result');
        if (!q) {
          out.textContent = 'Please enter a medicine name.';
          speak('Please enter a medicine name');
          return;
        }
        out.textContent = 'Searching...';
        try {
          const title = await searchWikipedia(q);
          if (!title) {
            out.textContent = 'No result found.';
            if (autoSpeak) speak('No result found');
            return;
          }
          const summary = await fetchSummary(title);
          out.innerHTML = `<strong>${title}</strong><p>${summary}</p><p><a href="https://en.wikipedia.org/wiki/${encodeURIComponent(title)}" target="_blank" rel="noopener">Learn more</a></p>`;
          if (autoSpeak) speak(`${title}. ${summary}`, currentLang);
        } catch(err){
          out.textContent = 'Error fetching information.';
          if (autoSpeak) speak('Error fetching information');
        }
      });

      // --- Simple Assistant: rules-based ---
      function simpleAdviceFromText(text){
        const t = (text||'').toLowerCase();
        if (!t) return "I didn't hear anything. Please try saying your problem.";
        if (t.includes('pain') || t.includes('ache') || t.includes('‡Æµ‡Æ≤‡Æø') || t.includes('‡Æµ‡Æ≤‡Æø‡Æ™‡Øç‡Æ™‡ØÅ')) {
          if (t.includes('chest') || t.includes('pressure')) {
            return "Chest pain can be serious. If severe, call emergency services now. Otherwise rest and seek medical help quickly.";
          }
          return "For general pain, rest, take prescribed pain relief if available, and contact a doctor if it worsens.";
        }
        if (t.includes('fever') || t.includes('temperature') || t.includes('‡Æï‡Ææ‡ÆØ‡Øç‡Æö‡Øç‡Æö‡Æ≤‡Øç')) {
          return "If you have fever, drink water, rest, and take paracetamol if allowed. If fever is high or persistent, consult a doctor.";
        }
        if (t.includes('dizzy') || t.includes('faint')) {
          return "If you feel faint, sit or lie down, loosen tight clothes and get fresh air. If it continues, seek immediate help.";
        }
        if (t.includes('cough') || t.includes('cold') || t.includes('‡Æï‡Ææ‡Æö‡Æø')) {
          return "For cough or cold, rest, warm fluids, and keep hydrated. See a doctor if you have trouble breathing.";
        }
        return "I am not sure. Try answering a few quick questions in the 'I don't know' section so I can help.";
      }

      $('assistant-submit').addEventListener('click', ()=>{
        const text = $('assistant-input').value.trim();
        const advice = simpleAdviceFromText(text);
        const out = $('assistant-output');
        out.textContent = advice;
        if (autoSpeak) speak(advice);
      });

      // --- Speech recognition for assistant (if available) ---
      let recognition = null;
      let listening = false;
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SR();
        recognition.lang = langToSpeech[currentLang] || 'en-US';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        recognition.onresult = (e) => {
          const tx = e.results[0][0].transcript;
          $('assistant-input').value = tx;
          $('assistant-submit').click();
        };
        recognition.onend = () => {
          listening = false;
          $('listen-btn').textContent = 'Start Listening';
        };
      }

      $('listen-btn').addEventListener('click', async ()=>{
        if (!recognition) {
          alert('Speech recognition not supported in this browser.');
          return;
        }
        try {
          recognition.lang = langToSpeech[currentLang] || 'en-US';
          recognition.start();
          listening = true;
          $('listen-btn').textContent = 'Listening... (click to stop)';
          recognition.onend = () => {
            listening = false;
            $('listen-btn').textContent = 'Start Listening';
          };
        } catch(err){
          console.error(err);
        }
      });

      $('speak-btn').addEventListener('click', ()=>{
        const text = $('assistant-input').value || 'How can I help you?';
        speak(text);
      });

      // --- Triage / branched questions ---
      const triageTree = {
        id: 'start',
        question: {
          en: 'Are you breathing normally?',
          ta: '‡Æ®‡ØÄ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æö‡Ææ‡Æ§‡Ææ‡Æ∞‡Æ£‡ÆÆ‡Ææ‡Æï ‡ÆÆ‡ØÇ‡Æö‡Øç‡Æö‡ØÅ ‡Æµ‡Æø‡Æü‡ØÅ‡Æï‡Æø‡Æ±‡ØÄ‡Æ∞‡Øç‡Æï‡Æ≥‡Ææ?',
          ml: '‡¥®‡¥ø‡¥ô‡µç‡¥ô‡µæ ‡¥∏‡¥æ‡¥ß‡¥æ‡¥∞‡¥£‡¥Æ‡¥æ‡¥Ø‡¥ø ‡¥∂‡µç‡¥µ‡¥æ‡¥∏‡¥Æ‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ‡¥£‡µç‡¥ü‡µã?',
          es: '¬øEst√°s respirando normalmente?'
        },
        choices: [
          {text:'Yes', next: 'bleed'},
          {text:'No', next: 'emergency'}
        ]
      };
      const triageNodes = {
        emergency: {
          question: {en:'This may be an emergency. Call emergency services or get help immediately.'},
          choices: []
        },
        bleed: {
          question: {en:'Do you have heavy bleeding?'},
          choices: [{text:'Yes', next:'stopBleed'}, {text:'No', next:'pain'}]
        },
        stopBleed: {
          question: {en:'Apply pressure to bleeding area and seek urgent care.'},
          choices: []
        },
        pain: {
          question: {en:'Do you feel severe pain?'},
          choices: [{text:'Yes', next:'seekDoctor'}, {text:'No', next:'rest'}]
        },
        seekDoctor: { question:{en:'Seek medical help.'}, choices:[] },
        rest: { question:{en:'Rest and observe. If it gets worse contact a doctor.'}, choices:[] }
      };

      let triageCurrent = null;
      const triageQ = $('triage-question');
      const triageChoices = $('triage-choices');

      function showTriageNode(id) {
        triageCurrent = id;
        const node = (id === 'start') ? triageTree : triageNodes[id];
        const qtext = (node.question && (node.question[currentLang] || node.question.en)) || '';
        triageQ.hidden = false;
        triageChoices.hidden = false;
        triageQ.textContent = qtext;
        triageChoices.innerHTML = '';
        if (!node.choices || node.choices.length===0) {
          const ok = document.createElement('button');
          ok.textContent = 'OK';
          ok.addEventListener('click', ()=>{ triageQ.hidden=true; triageChoices.hidden=true; });
          triageChoices.appendChild(ok);
          speak(qtext);
          return;
        }
        for (const c of node.choices) {
          const b = document.createElement('button');
          b.textContent = c.text;
          b.addEventListener('click', ()=> {
            showTriageNode(c.next);
          });
          triageChoices.appendChild(b);
        }
        speak(qtext);
      }

      $('start-triage').addEventListener('click', ()=> showTriageNode('start'));

      // --- Tablet scheduler (local reminders while page is open) ---
      const tabletListEl = $('tablet-list');
      const ALARMS = [];

      function renderTablets(){
        const list = JSON.parse(localStorage.getItem('kc-tablets') || '[]');
        tabletListEl.innerHTML = '';
        list.forEach((item, idx) => {
          const li = document.createElement('li');
          li.innerHTML = `<div><strong>${escapeHtml(item.name)}</strong><div>${item.time}</div></div>`;
          const rm = document.createElement('button');
          rm.textContent = 'Delete';
          rm.addEventListener('click', ()=>{
            list.splice(idx,1);
            localStorage.setItem('kc-tablets', JSON.stringify(list));
            renderTablets();
            scheduleAll();
          });
          li.appendChild(rm);
          tabletListEl.appendChild(li);
        });
      }

      function scheduleAll(){
        ALARMS.forEach(t => clearTimeout(t));
        ALARMS.length = 0;
        const list = JSON.parse(localStorage.getItem('kc-tablets') || '[]');
        list.forEach(item => {
          scheduleReminder(item);
        });
      }

      function scheduleReminder(item){
        const now = new Date();
        const [hh,mm] = item.time.split(':').map(Number);
        const next = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0, 0);
        if (next <= now) next.setDate(next.getDate()+1);
        const ms = next - now;
        const t = setTimeout(async ()=>{
          notify(`${item.name} - time to take your tablet`);
          const a = $('alarm-sound');
          try{ await a.play(); }catch(e){}
          scheduleReminder(item);
        }, ms);
        ALARMS.push(t);
      }

      function notify(message){
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification('KeyCare Reminder', {body: message});
        } else {
          alert(message);
        }
        if (voiceEnabled) speak(message);
      }

      $('add-tablet').addEventListener('click', ()=>{
        const name = $('tab-name').value.trim();
        const time = $('tab-time').value;
        if (!name || !time) return alert('Please enter name and time');
        const list = JSON.parse(localStorage.getItem('kc-tablets') || '[]');
        list.push({name, time});
        localStorage.setItem('kc-tablets', JSON.stringify(list));
        $('tab-name').value = '';
        $('tab-time').value = '';
        renderTablets();
        scheduleAll();
        speak('Reminder added');
      });

      function escapeHtml(str){
        return str.replace(/[&<>"']/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"}[m]));
      }

      // initialize
      renderTablets();
      scheduleAll();
      speak('Welcome to KeyCare. Use large buttons to choose a feature.', currentLang);

      // make sure voices refreshed
      if (typeof speechSynthesis !== 'undefined') {
        speechSynthesis.onvoiceschanged = () => {};
      }

      // Provide keyboard short-cuts and focus improvements for low-literacy:
      document.addEventListener('keydown', (e)=>{
        if (e.key === '1') document.querySelector('.float-btn[data-target="#medicines"]').click();
        if (e.key === '2') document.querySelector('.float-btn[data-target="#assistant"]').click();
        if (e.key === '3') document.querySelector('.float-btn[data-target="#triage"]').click();
        if (e.key === '4') document.querySelector('.float-btn[data-target="#tablets"]').click();
      });
    })();
  </script>
</body>
</html>
