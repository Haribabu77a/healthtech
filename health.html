<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Health Tech Assistant</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        /* [Previous CSS styles retained and improved] */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .header { background: white; padding: 15px 20px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 20px; color: #667eea; }
        .header-controls { display: flex; gap: 10px; }
        .page { display: none; background: white; border-radius: 15px; padding: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Interactive Elements */
        .btn { background: #667eea; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; transition: 0.3s; font-weight: bold; }
        .btn:hover { background: #764ba2; transform: translateY(-2px); }
        .card { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #667eea; cursor: pointer; transition: 0.2s; }
        .card:hover { transform: translateX(5px); background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .form-group { margin-bottom: 20px; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; }
        
        /* Map Container */
        #map { height: 400px; width: 100%; border-radius: 10px; margin-top: 15px; z-index: 1; }
        
        /* AI Response Styling */
        .ai-response { background: #e8f0fe; padding: 15px; border-radius: 10px; margin-top: 15px; border: 1px solid #b3d7ff; }
        .ai-loading { color: #667eea; font-style: italic; display: none; }
        
        /* Chat Interface */
        #chatMessages { height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #fafafa; }
        .message { margin-bottom: 10px; padding: 10px; border-radius: 8px; max-width: 80%; }
        .message.user { background: #667eea; color: white; margin-left: auto; }
        .message.ai { background: #e9ecef; color: #333; }

        /* API Key Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px; }
        
        /* Bottom Nav (Mobile friendly) */
        .bottom-nav { display: flex; justify-content: space-around; position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .nav-item { border: none; background: none; font-size: 24px; cursor: pointer; color: #aaa; }
        .nav-item.active { color: #667eea; }
    </style>
    
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
</head>
<body>

    <div id="apiModal" class="modal" style="display: flex;">
        <div class="modal-content">
            <h2>üîê Setup AI Features</h2>
            <p>To use the AI Advisor, Translation, and Image Analysis, you need a free Google Gemini API Key.</p>
            <div class="form-group">
                <input type="password" id="apiKeyInput" placeholder="Paste your API Key here">
            </div>
            <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Get one at <a href="https://aistudio.google.com/app/apikey" target="_blank">aistudio.google.com</a></p>
            <button class="btn" onclick="saveApiKey()">Start App</button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>Health Tech AI</h1>
            <div class="header-controls">
                <button class="btn" onclick="translatePage()" style="padding: 5px 10px; font-size: 12px;">üåê AI Translate</button>
            </div>
        </div>

        <div id="home" class="page active">
            <h2>Welcome</h2>
            <p style="margin-bottom: 20px; color: #666;">Your AI-powered health companion.</p>
            <div class="card" onclick="showPage('medicine')">
                <h3>üíä AI Medicine ID</h3>
                <p>Identify pills via Camera/Lens</p>
            </div>
            <div class="card" onclick="showPage('hospitals')">
                <h3>üè• Live Hospital Map</h3>
                <p>Real-time location & navigation</p>
            </div>
            <div class="card" onclick="showPage('advisor')">
                <h3>ü§ñ AI Health Advisor</h3>
                <p>Chat with an intelligent assistant</p>
            </div>
            <div class="card" onclick="showPage('profile')">
                <h3>üë§ Profile</h3>
                <p>Your data</p>
            </div>
        </div>

        <div id="medicine" class="page">
            <h2>üíä AI Medicine Analysis</h2>
            <p>Enter a name or take a photo to analyze purpose, dosage, and side effects.</p>
            
            <div class="form-group">
                <input type="text" id="medName" placeholder="e.g., Paracetamol, Amoxicillin">
                <button class="btn" style="width: 100%; margin-top: 10px;" onclick="analyzeMedicineText()">Analyze Name</button>
            </div>
            
            <div style="text-align: center; margin: 15px;">OR</div>
            
            <div class="form-group">
                <label class="btn" style="display: block; text-align: center;">
                    üì∑ Upload/Take Photo (Lens)
                    <input type="file" id="medImage" accept="image/*" style="display: none;" onchange="analyzeMedicineImage()">
                </label>
                <img id="imagePreview" style="max-width: 100%; margin-top: 10px; border-radius: 8px; display: none;">
            </div>

            <div id="medLoading" class="ai-loading">üîÆ AI is analyzing...</div>
            <div id="medResult" class="ai-response" style="display: none;"></div>
        </div>

        <div id="hospitals" class="page">
            <h2>üè• Nearby Hospitals</h2>
            <button class="btn" onclick="initMap()">üìç Find Hospitals Near Me</button>
            <div id="map"></div>
            <div id="hospitalList" style="margin-top: 20px;"></div>
        </div>

        <div id="advisor" class="page">
            <h2>ü§ñ AI Health Advisor</h2>
            <div id="chatMessages">
                <div class="message ai">Hello! I am your AI health assistant. How can I help you today?</div>
            </div>
            <div class="form-group" style="display: flex; gap: 10px;">
                <input type="text" id="userChatInput" placeholder="Ask about symptoms, diet, etc...">
                <button class="btn" onclick="sendChatMessage()">Send</button>
            </div>
        </div>
        
        <div id="profile" class="page">
            <h2>üë§ Profile</h2>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="pName" placeholder="Your Name">
            </div>
            <div class="form-group">
                <label>Emergency Contact</label>
                <input type="tel" id="pPhone">
            </div>
            <button class="btn" onclick="alert('Saved locally!')">Save</button>
        </div>
    </div>

    <div class="bottom-nav">
        <button class="nav-item active" onclick="showPage('home')">üè†</button>
        <button class="nav-item" onclick="showPage('medicine')">üíä</button>
        <button class="nav-item" onclick="showPage('hospitals')">üè•</button>
        <button class="nav-item" onclick="showPage('advisor')">ü§ñ</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        let genAI;
        let model;
        let apiKey = localStorage.getItem('gemini_api_key');

        // Initialize AI
        if (apiKey) {
            document.getElementById('apiModal').style.display = 'none';
            initializeAI(apiKey);
        }

        window.saveApiKey = function() {
            const key = document.getElementById('apiKeyInput').value;
            if(key) {
                localStorage.setItem('gemini_api_key', key);
                initializeAI(key);
                document.getElementById('apiModal').style.display = 'none';
            }
        }

        function initializeAI(key) {
            genAI = new GoogleGenerativeAI(key);
            model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
        }

        // --- Navigation ---
        window.showPage = function(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            // simple active state logic for demo
        }

        // --- AI Medicine Analysis (Text) ---
        window.analyzeMedicineText = async function() {
            const name = document.getElementById('medName').value;
            if(!name) return;
            
            const loader = document.getElementById('medLoading');
            const resultDiv = document.getElementById('medResult');
            
            loader.style.display = 'block';
            resultDiv.style.display = 'none';

            try {
                const prompt = `Provide detailed medical information for ${name}. Include: Usage, Common Dosage, Side Effects, and Warnings. Format effectively using Markdown.`;
                const result = await model.generateContent(prompt);
                const response = await result.response;
                const text = response.text();
                
                resultDiv.innerHTML = marked.parse(text);
                resultDiv.style.display = 'block';
            } catch (error) {
                alert("AI Error: Check API Key or Internet");
            } finally {
                loader.style.display = 'none';
            }
        }

        // --- AI Medicine Analysis (Image/Lens) ---
        window.analyzeMedicineImage = async function() {
            const fileInput = document.getElementById('medImage');
            const file = fileInput.files[0];
            const imagePreview = document.getElementById('imagePreview');
            
            if (!file) return;

            // Show preview
            const reader = new FileReader();
            reader.onload = async function(e) {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block';
                
                const loader = document.getElementById('medLoading');
                const resultDiv = document.getElementById('medResult');
                loader.style.display = 'block';
                loader.textContent = "üì∑ Analyzing image with AI Vision...";

                // Convert to Base64 (remove header)
                const base64Data = e.target.result.split(',')[1];

                try {
                    const prompt = "Analyze this image. If it is a medicine, identify it and list its usage, dosage, and side effects. If it is a symptom (like a rash), suggest possible causes. If it is not medical, say so.";
                    
                    const imagePart = {
                        inlineData: {
                            data: base64Data,
                            mimeType: file.type
                        }
                    };

                    const result = await model.generateContent([prompt, imagePart]);
                    const response = await result.response;
                    const text = response.text();
                    
                    resultDiv.innerHTML = marked.parse(text);
                    resultDiv.style.display = 'block';
                } catch (error) {
                    console.error(error);
                    resultDiv.innerHTML = "Error analyzing image.";
                    resultDiv.style.display = 'block';
                } finally {
                    loader.style.display = 'none';
                }
            };
            reader.readAsDataURL(file);
        }

        // --- AI Advisor Chat ---
        window.sendChatMessage = async function() {
            const input = document.getElementById('userChatInput');
            const text = input.value;
            if(!text) return;
            
            const chatBox = document.getElementById('chatMessages');
            
            // Add user message
            chatBox.innerHTML += `<div class="message user">${text}</div>`;
            input.value = '';
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                // Add loading indicator
                const loadingId = 'loading-' + Date.now();
                chatBox.innerHTML += `<div id="${loadingId}" class="message ai">Thinking...</div>`;
                
                const prompt = `You are a helpful and empathetic health assistant. Answer this query briefly: ${text}`;
                const result = await model.generateContent(prompt);
                const response = await result.response;
                const aiText = response.text();
                
                document.getElementById(loadingId).remove();
                chatBox.innerHTML += `<div class="message ai">${marked.parse(aiText)}</div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
            } catch (error) {
                console.error(error);
            }
        }

        // --- AI Language Translation (Dynamic) ---
        window.translatePage = async function() {
            const targetLang = prompt("Enter target language (e.g., Spanish, Hindi, French):");
            if(!targetLang) return;

            alert("AI is translating the interface... this may take a few seconds.");

            // Select key text elements to translate
            const elements = document.querySelectorAll('h2, h3, p, button, label');
            
            // Create a batch of text to reduce API calls (simplified for demo)
            // In a production app, we would send a JSON object of strings
            
            for (let el of elements) {
                if(el.innerText.length > 0 && el.innerText.length < 100) {
                    try {
                        const result = await model.generateContent(`Translate this exact text to ${targetLang}: "${el.innerText}"`);
                        el.innerText = result.response.text();
                    } catch(e) {
                        console.log("Translation skip");
                    }
                }
            }
            alert("Translation Complete!");
        }
    </script>

    <script>
        // --- Live Map (Leaflet JS) ---
        let map;
        
        function initMap() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition, showError);
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function showPosition(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            // Initialize Map if not already done
            if(map) {
                map.setView([lat, lng], 14);
                return;
            }
            
            map = L.map('map').setView([lat, lng], 14);

            // Add OpenStreetMap Tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Add User Marker
            L.marker([lat, lng]).addTo(map)
                .bindPopup('You are here')
                .openPopup();

            findNearbyHospitals(lat, lng);
        }

        function findNearbyHospitals(lat, lng) {
            // Using Overpass API to find hospitals dynamically
            const query = `
                [out:json];
                node["amenity"="hospital"](around:3000,${lat},${lng});
                out;
            `;
            const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const list = document.getElementById('hospitalList');
                    list.innerHTML = '<h3>Nearby Hospitals Found:</h3>';
                    
                    data.elements.forEach(hospital => {
                        if(hospital.lat && hospital.lon) {
                            // Add pin to map
                            const name = hospital.tags.name || "Unknown Hospital";
                            L.marker([hospital.lat, hospital.lon]).addTo(map)
                                .bindPopup(`<b>${name}</b>`);
                            
                            // Add to list
                            list.innerHTML += `
                                <div class="card" onclick="map.setView([${hospital.lat}, ${hospital.lon}], 16)">
                                    <h4>${name}</h4>
                                    <p>Click to locate</p>
                                </div>
                            `;
                        }
                    });
                })
                .catch(err => console.error(err));
        }

        function showError(error) {
            alert("Error getting location: " + error.message);
        }
    </script>
</body>
</html>
